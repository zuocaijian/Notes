> 在一款移动端应用中，XX详情页通常是其核心所在，信息量丰富、布局较为复杂、业务逻辑较多。因此，逆向分析一款市场成熟应用详情页，可以学到很多有意思的东西。

> 在使用Android手机的 应用宝 客户端时，发现其apk详情页布局能很好的满足当前这一类型主流应用的信息展示，滑动流程且基本无冲突，因此想了解其布局的嵌套层次以及多个可滚动控件之间的滑动冲突的解决方案。

# 准备工作 
  1. 下载应用宝apk文件; 
  2. 下载反编译所需的三款工具：apktool，dex2jar，jdgui。其中apktool可用来反编译及签名、重打包用的。其核心文件apktool.jar最新版本可在[官网下载](http://www.softpedia.com/get/Programming/Debuggers-Decompilers-Dissasemblers/ApkTool.shtml#download)。dex2jar是用来将dex文件转换成jar包文件的，jdgui则是用来查看jar文件的;

# 反编译apk
  > Android的安装文件apk其实是zip压缩包，不过如果直接解压缩，会发现不管是资源文件(layout、values、attr、style、AndroidManifest等等)都是乱码的，所以需要用到apktool进行反编译。  

  1. 在命令行中可使用java -jar apktool.jar来查看该工具的用法。针对于反编译，其简单用法是：**java -jar apktool.jar d -s xx.apk**，即可得到一个反编译后xx文件夹。该命令中，加入 "-s" 是进制源文件反编译，以遍我们阅读反编译后的java代码。如果不加 "-s" 选项，则会反编译得到.smail文件，通常反编译apk，并对其进行修改，然后签名重打包会用到，不过这需要对.smail文件语法较为熟悉才行。其他选项如 "-o" 可指定反编译后输出文件路径。其他用法可查看帮助；  
  2. 经过上一个步骤，我们可以拿到初步反编译后的文件，这时候AndroidManifest.xml文件是可以直接查看了。我们可以从该文件中大致了解到apk中的启动入口、权限申请、运行服务及注册的广播接收、主题设置等常见的配置情况。也可以了解下apk中所包含的图片资源、布局等等一系列资源文件；  
  3. 如果在反编译输出文件夹中能直接找到classes.dex文件，说明该apk并没有做加固处理，否则还需要对apk进行脱壳才能拿到classes.dex。脱壳涉及到其他许多技术和知识，因此这里不做过多说明。使用dex2jar工具将dex文件转换为jar文件，然后使用jdgui查看jar文件即可。如果文件没有经过混淆，那么，恭喜你，源码就摆在你面前，任你翻阅。不过一般来说，这种概率非常小，所以我们拿到的基本是经过混淆的代码，需要我们仔细分析才行。

# 分析
  > 在做工程逆向的时候，分析不仅需要足够的知识，更需要耐心和时间。

  1. **定位Activity：**由于我们主要是查看应用宝详情页的布局，嵌套层次及滑动解决方案，因此我们首先需要找到详情页对面的Activity及响应的layout文件。在手机上安装apk包，打开详情页，在调试模式下使用adb命令"adb shell dumpsys activity | findstr "mFocusedActivity"即可获得当前Activity的名字及路径；  
  2. **定位资源文件：**在jar包中根据路径及文件名找到Activity对应的class文件。为方便分析及使用习惯，可将jar包拷贝到AndroidStudio项目下并应用，这样在查看跳转、方法调用、类层次结果的时候效率会高很多。在Activity文件中，我们直接查找"setContentView()"方法，可以看到其参数是一个10进制的整形值，也就是layout资源id。使用计算器工具将其转换得到对应的16进制值。有了资源id，我们需要通过R文件找到其layout文件名字的映射关系。打包后的R.class文件直接找是找不到的，但其实会放在public.xml里，一般位于res/values目录下。这样我们便可以找到对应的资源文件名，R.id、R.string、R.id、R.style等等都可以通过这种方式找到；  
  3. **布局分析：**在layout的xml文件中我们可以看到Activity的对应的布局文件。不过不幸的是，应用宝详情页中其对应的xml布局文件非常简单，看来其大部分布局逻辑都已经进行了高度封装，所以我们需要对其进一步分析；  
  4. **代码分析：**通过布局中的控件id，以及代码中的"findViewById()"方法，我们可以对布局文件中的控件进行跟踪分析。发现其详情页加载逻辑的主要有一个叫"AppDetailNormalPage"的类完成，跳转进入该类，索搜"inflate"关键字，重复步骤2，即可分析出其真正的布局xml文件。
  5. **逆向：**重复并结合上述文件定位、布局分析、代码分析方法，通过合理猜测、索搜等方式可最终获取到我们想要的答案。

---
### 总结
  工程逆向是一门很深的学问，需要有扎实的基础及强大的分析能力，技术深度和广度缺一不可。工程逆向比较能考察一个人的综合技术水平，也很能锻炼提升一个人解决问题的能力。当然，通过工程逆向，我们也能学到其他人、高手甚至是业内顶尖公司的对于某一问题的技术解决方案。